// src/composables/useSpeechSynthesis.js

import { ref, computed, onMounted } from 'vue';
import { useSettingsStore } from '../stores/settingsStore';

/**
 * –ö–æ–º–ø–æ–∑–∞–±–ª –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏–Ω—Ç–µ–∑–æ–º —Ä–µ—á–∏ (Web Speech API)
 *
 * –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
 * - –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤ –û–°
 * - –û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
 * - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç —Ç–µ–º–ø–∞ —Ä–µ—á–∏
 * - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥—å—é (pause/resume/cancel)
 *
 * @returns {Object} API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–∑–≤—É—á–∫–æ–π
 */
export function useSpeechSynthesis() {
  const settingsStore = useSettingsStore();

  // ==========================================
  // –°–û–°–¢–û–Ø–ù–ò–ï
  // ==========================================

  /**
   * –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≥–æ–ª–æ—Å–∞ –≤ —Å–∏—Å—Ç–µ–º–µ
   */
  const availableVoices = ref([]);

  /**
   * –¢–µ–∫—É—â–∞—è –æ–∑–≤—É—á–∏–≤–∞–µ–º–∞—è —Ñ—Ä–∞–∑–∞ (SpeechSynthesisUtterance)
   */
  const currentUtterance = ref(null);

  /**
   * –ò–¥—ë—Ç –ª–∏ –æ–∑–≤—É—á–∫–∞ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
   */
  const isSpeaking = ref(false);

  /**
   * –ü–æ—Å–ª–µ–¥–Ω–∏–π –æ–∑–≤—É—á–µ–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å —Å—É–±—Ç–∏—Ç—Ä–∞ (—á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å)
   */
  const lastSpokenIndex = ref(-1);

  // ==========================================
  // COMPUTED
  // ==========================================

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ–ª–æ—Å (–æ–±—ä–µ–∫—Ç SpeechSynthesisVoice)
   */
  const selectedVoice = computed(() => {
    if (!settingsStore.selectedVoiceName) return null;

    return availableVoices.value.find((v) => v.name === settingsStore.selectedVoiceName) || null;
  });

  /**
   * –¢–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–µ –≥–æ–ª–æ—Å–∞
   */
  const russianVoices = computed(() => {
    return availableVoices.value.filter((voice) => voice.lang.includes('ru') || voice.lang.includes('RU'));
  });

  /**
   * –ï—Å—Ç—å –ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ä—É—Å—Å–∫–∏–µ –≥–æ–ª–æ—Å–∞
   */
  const hasRussianVoices = computed(() => russianVoices.value.length > 0);

  // ==========================================
  // –ó–ê–ì–†–£–ó–ö–ê –ì–û–õ–û–°–û–í
  // ==========================================

  /**
   * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
   *
   * –í–∞–∂–Ω–æ: –≥–æ–ª–æ—Å–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ!
   * –ù–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö –Ω—É–∂–Ω–æ –¥–æ–∂–¥–∞—Ç—å—Å—è —Å–æ–±—ã—Ç–∏—è 'voiceschanged'
   */
  // function loadVoices() {
  //   const voices = speechSynthesis.getVoices();

  //   if (voices.length > 0) {
  //     availableVoices.value = voices;
  //     console.log('üé§ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –≥–æ–ª–æ—Å–æ–≤:', voices.length);
  //     console.log('üá∑üá∫ –†—É—Å—Å–∫–∏—Ö –≥–æ–ª–æ—Å–æ–≤:', russianVoices.value.length);

  //     // –ï—Å–ª–∏ –≥–æ–ª–æ—Å –Ω–µ –≤—ã–±—Ä–∞–Ω - –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Ä—É—Å—Å–∫–∏–π
  //     if (!settingsStore.selectedVoice && russianVoices.value.length > 0) {
  //       settingsStore.selectedVoice = russianVoices.value[0];
  //       settingsStore.saveSettings();
  //       console.log('‚úÖ –í—ã–±—Ä–∞–Ω –≥–æ–ª–æ—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:', settingsStore.selectedVoice.name);
  //     }
  //   }
  // }
  function loadVoices() {
    const voices = speechSynthesis.getVoices();

    if (voices.length > 0) {
      availableVoices.value = voices;
      console.log('üé§ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –≥–æ–ª–æ—Å–æ–≤:', voices.length);
      console.log('üá∑üá∫ –†—É—Å—Å–∫–∏—Ö –≥–æ–ª–æ—Å–æ–≤:', russianVoices.value.length);

      // –ï—Å–ª–∏ –∏–º—è –≥–æ–ª–æ—Å–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ - –Ω–∞—Ö–æ–¥–∏–º –µ–≥–æ –≤ —Å–ø–∏—Å–∫–µ
      if (settingsStore.selectedVoiceName) {
        const savedVoice = voices.find((v) => v.name === settingsStore.selectedVoiceName);

        if (savedVoice) {
          console.log('‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≥–æ–ª–æ—Å:', savedVoice.name);
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ computed —Å–≤–æ–π—Å—Ç–≤–æ (—Å–º. –Ω–∏–∂–µ)
        } else {
          console.log('‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –≥–æ–ª–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤—ã–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π');
          selectDefaultVoice();
        }
      } else {
        // –ì–æ–ª–æ—Å –Ω–µ –≤—ã–±—Ä–∞–Ω - –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Ä—É—Å—Å–∫–∏–π
        selectDefaultVoice();
      }
    }
  }

  /**
   * –í—ã–±—Ä–∞—Ç—å –≥–æ–ª–æ—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–µ—Ä–≤—ã–π —Ä—É—Å—Å–∫–∏–π)
   */
  function selectDefaultVoice() {
    if (russianVoices.value.length > 0) {
      settingsStore.selectedVoiceName = russianVoices.value[0].name;
      settingsStore.saveSettings();
      console.log('‚úÖ –í—ã–±—Ä–∞–Ω –≥–æ–ª–æ—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:', russianVoices.value[0].name);
    }
  }

  // ==========================================
  // –†–ê–°–ß–Å–¢ –î–ò–ù–ê–ú–ò–ß–ï–°–ö–û–ì–û –¢–ï–ú–ü–ê
  // ==========================================

  /**
   * –í—ã—á–∏—Å–ª—è–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ç–µ–º–ø —Ä–µ—á–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–ª–∏–Ω—ã —Ç–µ–∫—Å—Ç–∞ –∏ –≤—Ä–µ–º–µ–Ω–∏
   *
   * @param {string} text - –¢–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏
   * @param {number} duration - –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
   * @returns {number} - –¢–µ–º–ø —Ä–µ—á–∏ (0.5 - 2.0)
   */
  function calculateOptimalRate(text, duration) {
    // –ë–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    let rate = settingsStore.voiceRate;

    // –ï—Å–ª–∏ –∞–≤—Ç–æ-—Ç–µ–º–ø –≤—ã–∫–ª—é—á–µ–Ω - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤—ã–π
    if (!settingsStore.autoAdjustRate) {
      return rate;
    }

    // –í—ã—á–∏—Å–ª—è–µ–º —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω—É–∂–Ω–æ –Ω–∞ —Å–∏–º–≤–æ–ª –ø—Ä–∏ –±–∞–∑–æ–≤–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏
    // –°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–µ—á–∏: ~12-14 —Å–∏–º–≤–æ–ª–æ–≤/—Å–µ–∫ –ø—Ä–∏ rate=1.0
    const CHARS_PER_SECOND_AT_RATE_1 = 12;

    // –°–∫–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª–æ–≤ –Ω—É–∂–Ω–æ –æ–∑–≤—É—á–∏—Ç—å
    const textLength = text.length;

    // –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω—É–∂–Ω–æ –ø—Ä–∏ –±–∞–∑–æ–≤–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏
    const requiredTime = textLength / CHARS_PER_SECOND_AT_RATE_1;

    // –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ —á–µ–º –µ—Å—Ç—å - —É—Å–∫–æ—Ä—è–µ–º
    if (requiredTime > duration) {
      // –í—ã—á–∏—Å–ª—è–µ–º –Ω—É–∂–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å–∫–æ—Ä–µ–Ω–∏—è
      const speedMultiplier = requiredTime / duration;
      rate = Math.min(rate * speedMultiplier, 2.0); // –ú–∞–∫—Å–∏–º—É–º 2.0x

      console.log(`‚ö° –£—Å–∫–æ—Ä–µ–Ω–∏–µ: ${textLength} —Å–∏–º–≤–æ–ª–æ–≤ –∑–∞ ${duration.toFixed(1)}s —Ç—Ä–µ–±—É—é—Ç rate=${rate.toFixed(2)}`);
    } else if (requiredTime < duration * 0.5) {
      // –ï—Å–ª–∏ –≤—Ä–µ–º–µ–Ω–∏ –º–Ω–æ–≥–æ - –º–æ–∂–Ω–æ –∑–∞–º–µ–¥–ª–∏—Ç—å –¥–ª—è –ª—É—á—à–µ–π —Ä–∞–∑–±–æ—Ä—á–∏–≤–æ—Å—Ç–∏
      rate = Math.max(rate * 0.9, 0.75); // –ú–∏–Ω–∏–º—É–º 0.75x
    }

    return rate;
  }

  // ==========================================
  // –û–°–ù–û–í–ù–´–ï –ú–ï–¢–û–î–´
  // ==========================================

  /**
   * –û–∑–≤—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç
   *
   * @param {string} text - –¢–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏
   * @param {Object} options - –û–ø—Ü–∏–∏
   * @param {number} options.duration - –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å—É–±—Ç–∏—Ç—Ä–∞ (—Å–µ–∫—É–Ω–¥—ã)
   * @param {number} options.index - –ò–Ω–¥–µ–∫—Å —Å—É–±—Ç–∏—Ç—Ä–∞
   */
  function speak(text, options = {}) {
    const { duration = 3, timeRemaining = duration, index = -1 } = options;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ–∑–≤—É—á–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞
    if (!settingsStore.isDubbingEnabled) {
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–µ–∫—Å—Ç –Ω–µ –ø—É—Å—Ç–æ–π
    if (!text || text.trim().length === 0) {
      return;
    }

    // –ù–µ –æ–∑–≤—É—á–∏–≤–∞–µ–º –µ—Å–ª–∏ —ç—Ç–æ —Ç–æ—Ç –∂–µ —Å—É–±—Ç–∏—Ç—Ä
    if (lastSpokenIndex.value === index) {
      return;
    }

    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–µ–¥—ã–¥—É—â–∞—è —Ñ—Ä–∞–∑–∞ —Ä–µ–∞–ª—å–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç
    // speechSynthesis.speaking –º–æ–∂–µ—Ç –±—ã—Ç—å true –¥–∞–∂–µ –∫–æ–≥–¥–∞ –∑–≤—É–∫–∞ –Ω–µ—Ç
    if (window.speechSynthesis.speaking) {
      // –¢–æ–ª—å–∫–æ –æ—Ç–º–µ–Ω—è–µ–º –µ—Å–ª–∏ –≤—Ä–µ–º–µ–Ω–∏ –º–∞–ª–æ
      if (timeRemaining < 2.0) {
        console.log('‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫: —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ –≤—Ä–µ–º–µ–Ω–∏');
        return;
      }

      // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Ñ—Ä–∞–∑—É
      window.speechSynthesis.cancel();

      // –í–ê–ñ–ù–û: –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –æ—á–µ—Ä–µ–¥–∏
      // –í Chrome speechSynthesis —Ç—Ä–µ–±—É–µ—Ç –≤—Ä–µ–º—è –Ω–∞ –æ—á–∏—Å—Ç–∫—É
      setTimeout(() => {
        actuallySpeak(text, duration, timeRemaining, index);
      }, 50);
    } else {
      // –û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞, –≥–æ–≤–æ—Ä–∏–º —Å—Ä–∞–∑—É
      actuallySpeak(text, duration, timeRemaining, index);
    }
  }

  /**
   * –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –æ–∑–≤—É—á–∫–∏
   */
  function actuallySpeak(text, duration, timeRemaining, index) {
    // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é —Ñ—Ä–∞–∑—É
    const utterance = new SpeechSynthesisUtterance(text);

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    const calculatedRate = calculateOptimalRate(text, timeRemaining);
    utterance.rate = calculatedRate;
    utterance.pitch = settingsStore.voicePitch;
    utterance.volume = settingsStore.voiceVolume / 100;
    utterance.lang = 'ru-RU';

    // –ì–æ–ª–æ—Å
    const voice = selectedVoice.value;
    if (voice) {
      utterance.voice = voice;
    }

    // –õ–æ–≥–∏
    console.log('üé§ –û–∑–≤—É—á–∫–∞:', {
      text: text.substring(0, 40) + '...',
      rate: utterance.rate.toFixed(2),
      volume: utterance.volume.toFixed(2),
      voiceName: voice ? voice.name : 'default',
    });

    // –°–æ–±—ã—Ç–∏—è
    utterance.onstart = () => {
      isSpeaking.value = true;
      currentUtterance.value = utterance;
      lastSpokenIndex.value = index;
      console.log(`‚úÖ –û–∑–≤—É—á–∫–∞ –Ω–∞—á–∞–ª–∞—Å—å: "${text.substring(0, 30)}..."`);
    };

    utterance.onend = () => {
      isSpeaking.value = false;
      currentUtterance.value = null;
      console.log('‚úÖ –û–∑–≤—É—á–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
    };

    utterance.onerror = (event) => {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è
      if (event.error === 'canceled' || event.error === 'interrupted') {
        console.log('üîÑ –û–∑–≤—É—á–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞');
        isSpeaking.value = false;
        currentUtterance.value = null;
        return;
      }

      console.error('‚ùå –û—à–∏–±–∫–∞ –æ–∑–≤—É—á–∫–∏:', event.error);
      isSpeaking.value = false;
      currentUtterance.value = null;
    };

    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–∑–≤—É—á–∫—É
    window.speechSynthesis.speak(utterance);
    console.log('‚ñ∂Ô∏è speak() –≤—ã–∑–≤–∞–Ω');
  }

  /**
   * –û—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –æ–∑–≤—É—á–∫—É
   */
  function cancel() {
    if (speechSynthesis.speaking) {
      speechSynthesis.cancel();
      isSpeaking.value = false;
      currentUtterance.value = null;
      console.log('üõë –û–∑–≤—É—á–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞');
    }
  }

  /**
   * –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–∑–≤—É—á–∫—É
   */
  function pause() {
    if (speechSynthesis.speaking && !speechSynthesis.paused) {
      speechSynthesis.pause();
      console.log('‚è∏Ô∏è –û–∑–≤—É—á–∫–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
    }
  }

  /**
   * –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –æ–∑–≤—É—á–∫—É
   */
  function resume() {
    if (speechSynthesis.paused) {
      speechSynthesis.resume();
      console.log('‚ñ∂Ô∏è –û–∑–≤—É—á–∫–∞ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∞');
    }
  }

  /**
   * –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ø—Ä–∏ –ø–µ—Ä–µ–º–æ—Ç–∫–µ)
   */
  function reset() {
    cancel();
    lastSpokenIndex.value = -1;
  }

  // ==========================================
  // LIFECYCLE
  // ==========================================

  onMounted(() => {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ–ª–æ—Å–∞ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    loadVoices();

    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ–ª–æ—Å–æ–≤
    // (–Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö –≥–æ–ª–æ—Å–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = loadVoices;
    }
  });

  // ==========================================
  // PUBLIC API
  // ==========================================

  return {
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ
    availableVoices,
    russianVoices,
    hasRussianVoices,
    isSpeaking,
    lastSpokenIndex,
    selectedVoice,

    // –ú–µ—Ç–æ–¥—ã
    speak,
    cancel,
    pause,
    resume,
    reset,
    loadVoices,
  };
}
